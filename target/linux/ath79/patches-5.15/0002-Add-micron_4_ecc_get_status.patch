From 4801437946a8aa064719afeb645179ba1e01d93a Mon Sep 17 00:00:00 2001
From: Micha Ober <git@ober-mail.de>
Date: Tue, 6 Feb 2024 19:11:11 +0100
Subject: [PATCH] Add micron_4_ecc_get_status

---
 drivers/mtd/nand/spi/micron.c | 21 ++++++++++++++++++++-
 1 file changed, 20 insertions(+), 1 deletion(-)

diff --git a/drivers/mtd/nand/spi/micron.c b/drivers/mtd/nand/spi/micron.c
index b70a328ce5c0..fe3ee81e4c5f 100644
--- a/drivers/mtd/nand/spi/micron.c
+++ b/drivers/mtd/nand/spi/micron.c
@@ -169,6 +169,24 @@ static int micron_8_ecc_get_status(struct spinand_device *spinand,
 	return -EINVAL;
 }
 
+static int micron_4_ecc_get_status(struct spinand_device *spinand,
+				   u8 status)
+{
+	printk(KERN_INFO "micron_4_ecc_get_status status = %d", status);
+
+	switch (status & STATUS_ECC_MASK) {
+	case STATUS_ECC_NO_BITFLIPS:
+		return 0;
+	case STATUS_ECC_HAS_BITFLIPS:
+		/* 1 to 4-bit error detected and corrected */
+		return 4;
+	case STATUS_ECC_UNCOR_ERROR:
+		return -EBADMSG;
+	default:
+		return -EINVAL;
+	}
+}
+
 static const struct spinand_info micron_spinand_table[] = {
 	/* M79A 2Gb 3.3V */
 	SPINAND_INFO("MT29F2G01ABAGD",
@@ -291,7 +309,8 @@ static const struct spinand_info micron_spinand_table[] = {
 					      &x1_write_cache_variants,
 					      &x1_update_cache_variants),
 		     0,
-		     SPINAND_ECCINFO(&micron_4_ooblayout, NULL)),
+		     SPINAND_ECCINFO(&micron_4_ooblayout,
+		     		     micron_4_ecc_get_status)),
 };
 
 static int micron_spinand_init(struct spinand_device *spinand)
-- 
2.34.1

